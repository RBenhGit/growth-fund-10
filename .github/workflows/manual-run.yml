name: Manual Fund Build

on:
  workflow_dispatch:
    inputs:
      index:
        description: 'Index to build (SP500 or TASE125)'
        required: true
        type: choice
        options:
          - SP500
          - TASE125
          - BOTH
      quarter:
        description: 'Quarter (Q1, Q2, Q3, Q4) - leave empty for auto-detect'
        required: false
        type: string
      year:
        description: 'Year (e.g., 2026) - leave empty for current year'
        required: false
        type: string
      use_cache:
        description: 'Use cached data'
        required: true
        type: boolean
        default: true
      debug:
        description: 'Enable debug mode'
        required: true
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: growth-fund-builder-cluster

jobs:
  run-sp500:
    name: Build SP500 Fund
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.index == 'SP500' || github.event.inputs.index == 'BOTH' }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run ECS task for SP500
        run: |
          QUARTER_ARG=""
          YEAR_ARG=""
          CACHE_FLAG=""
          DEBUG_FLAG=""

          if [ -n "${{ github.event.inputs.quarter }}" ]; then
            QUARTER_ARG="--quarter ${{ github.event.inputs.quarter }}"
          fi

          if [ -n "${{ github.event.inputs.year }}" ]; then
            YEAR_ARG="--year ${{ github.event.inputs.year }}"
          fi

          if [ "${{ github.event.inputs.use_cache }}" != "true" ]; then
            CACHE_FLAG="--no-cache"
          fi

          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            DEBUG_FLAG="--debug"
          fi

          # Get subnet and security group from ECS cluster config
          SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=tag:Project,Values=GrowthFundBuilder" --query 'Subnets[0].SubnetId' --output text)
          SG_ID=$(aws ec2 describe-security-groups --filters "Name=tag:Project,Values=GrowthFundBuilder" --query 'SecurityGroups[0].GroupId' --output text)

          # Run ECS task
          aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition growth-fund-builder-sp500 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_ID],securityGroups=[$SG_ID],assignPublicIp=DISABLED}" \
            --overrides "{\"containerOverrides\":[{\"name\":\"growth-fund-sp500\",\"command\":[\"--index\",\"SP500\",$QUARTER_ARG,$YEAR_ARG,$CACHE_FLAG,$DEBUG_FLAG]}]}"

      - name: Output summary
        run: |
          echo "‚úÖ SP500 fund build task started"
          echo "üìä Index: SP500"
          echo "üìÖ Quarter: ${{ github.event.inputs.quarter || 'auto-detect' }}"
          echo "üìÜ Year: ${{ github.event.inputs.year || 'current' }}"
          echo "üíæ Cache: ${{ github.event.inputs.use_cache }}"
          echo "üêõ Debug: ${{ github.event.inputs.debug }}"

  run-tase125:
    name: Build TASE125 Fund
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.index == 'TASE125' || github.event.inputs.index == 'BOTH' }}
    needs: [run-sp500]
    # Allow this job to run even if run-sp500 is skipped
    if: always()

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run ECS task for TASE125
        run: |
          QUARTER_ARG=""
          YEAR_ARG=""
          CACHE_FLAG=""
          DEBUG_FLAG=""

          if [ -n "${{ github.event.inputs.quarter }}" ]; then
            QUARTER_ARG="--quarter ${{ github.event.inputs.quarter }}"
          fi

          if [ -n "${{ github.event.inputs.year }}" ]; then
            YEAR_ARG="--year ${{ github.event.inputs.year }}"
          fi

          if [ "${{ github.event.inputs.use_cache }}" != "true" ]; then
            CACHE_FLAG="--no-cache"
          fi

          if [ "${{ github.event.inputs.debug }}" == "true" ]; then
            DEBUG_FLAG="--debug"
          fi

          # Get subnet and security group
          SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=tag:Project,Values=GrowthFundBuilder" --query 'Subnets[0].SubnetId' --output text)
          SG_ID=$(aws ec2 describe-security-groups --filters "Name=tag:Project,Values=GrowthFundBuilder" --query 'SecurityGroups[0].GroupId' --output text)

          # Run ECS task
          aws ecs run-task \
            --cluster ${{ env.ECS_CLUSTER }} \
            --task-definition growth-fund-builder-tase125 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNET_ID],securityGroups=[$SG_ID],assignPublicIp=DISABLED}" \
            --overrides "{\"containerOverrides\":[{\"name\":\"growth-fund-tase125\",\"command\":[\"--index\",\"TASE125\",$QUARTER_ARG,$YEAR_ARG,$CACHE_FLAG,$DEBUG_FLAG]}]}"

      - name: Output summary
        run: |
          echo "‚úÖ TASE125 fund build task started"
          echo "üìä Index: TASE125"
          echo "üìÖ Quarter: ${{ github.event.inputs.quarter || 'auto-detect' }}"
          echo "üìÜ Year: ${{ github.event.inputs.year || 'current' }}"
          echo "üíæ Cache: ${{ github.event.inputs.use_cache }}"
          echo "üêõ Debug: ${{ github.event.inputs.debug }}"
